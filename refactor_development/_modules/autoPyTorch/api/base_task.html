<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>autoPyTorch.api.base_task &#8212; AutoPyTorch 0.0.3 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-rendered-html.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>
  
  <a href="https://github.com/automl/Auto-PyTorch"
     class="visible-desktop hidden-xs"><img
    id="gh-banner"
    style="position: absolute; top: 50px; right: 0; border: 0;"
    src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
    alt="Fork me on GitHub"></a>
  <script>
    // Adjust banner height.
    $(function () {
      var navHeight = $(".navbar .container").css("height");
      $("#gh-banner").css("top", navHeight);
    });
  </script>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Auto-PyTorch</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.3</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../index.html">Start</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../manual.html">Manual</a></li>
                <li><a href="../../../examples/index.html">Examples</a></li>
                <li><a href="../../../api.html">API</a></li>
                <li><a href="../../../extending.html">Extending</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for autoPyTorch.api.base_task</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">unittest.mock</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">ConfigSpace.configuration_space</span> <span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">ConfigurationSpace</span>

<span class="kn">import</span> <span class="nn">dask</span>

<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">smac.runhistory.runhistory</span> <span class="kn">import</span> <span class="n">RunHistory</span>
<span class="kn">from</span> <span class="nn">smac.stats.stats</span> <span class="kn">import</span> <span class="n">Stats</span>
<span class="kn">from</span> <span class="nn">smac.tae</span> <span class="kn">import</span> <span class="n">StatusType</span>

<span class="kn">from</span> <span class="nn">autoPyTorch.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">REGRESSION_TASKS</span><span class="p">,</span>
    <span class="n">STRING_TO_OUTPUT_TYPES</span><span class="p">,</span>
    <span class="n">STRING_TO_TASK_TYPES</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.datasets.base_dataset</span> <span class="kn">import</span> <span class="n">BaseDataset</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.datasets.resampling_strategy</span> <span class="kn">import</span> <span class="n">CrossValTypes</span><span class="p">,</span> <span class="n">HoldoutValTypes</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.ensemble.ensemble_builder</span> <span class="kn">import</span> <span class="n">EnsembleBuilderManager</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.ensemble.ensemble_selection</span> <span class="kn">import</span> <span class="n">EnsembleSelection</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.ensemble.singlebest_ensemble</span> <span class="kn">import</span> <span class="n">SingleBest</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.evaluation.abstract_evaluator</span> <span class="kn">import</span> <span class="n">fit_and_suppress_warnings</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.evaluation.tae</span> <span class="kn">import</span> <span class="n">ExecuteTaFuncWithQueue</span><span class="p">,</span> <span class="n">get_cost_of_crash</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.optimizer.smbo</span> <span class="kn">import</span> <span class="n">AutoMLSMBO</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.pipeline.base_pipeline</span> <span class="kn">import</span> <span class="n">BasePipeline</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.pipeline.components.setup.traditional_ml.classifier_models</span> <span class="kn">import</span> <span class="n">get_available_classifiers</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.pipeline.components.training.metrics.base</span> <span class="kn">import</span> <span class="n">autoPyTorchMetric</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.pipeline.components.training.metrics.utils</span> <span class="kn">import</span> <span class="n">calculate_score</span><span class="p">,</span> <span class="n">get_metrics</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.utils.backend</span> <span class="kn">import</span> <span class="n">Backend</span><span class="p">,</span> <span class="n">create</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.utils.common</span> <span class="kn">import</span> <span class="n">FitRequirement</span><span class="p">,</span> <span class="n">replace_string_bool_to_bool</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.utils.hyperparameter_search_space_update</span> <span class="kn">import</span> <span class="n">HyperparameterSearchSpaceUpdates</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.utils.logging_</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PicklableClientLogger</span><span class="p">,</span>
    <span class="n">get_named_client_logger</span><span class="p">,</span>
    <span class="n">setup_logger</span><span class="p">,</span>
    <span class="n">start_log_server</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.utils.pipeline</span> <span class="kn">import</span> <span class="n">get_configuration_space</span><span class="p">,</span> <span class="n">get_dataset_requirements</span>
<span class="kn">from</span> <span class="nn">autoPyTorch.utils.stopwatch</span> <span class="kn">import</span> <span class="n">StopWatch</span>


<span class="k">def</span> <span class="nf">_pipeline_predict</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">BasePipeline</span><span class="p">,</span>
                      <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                      <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">logger</span><span class="p">:</span> <span class="n">PicklableClientLogger</span><span class="p">,</span>
                      <span class="n">task</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="nd">@typing</span><span class="o">.</span><span class="n">no_type_check</span>
    <span class="k">def</span> <span class="nf">send_warnings_to_log</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="n">send_warnings_to_log</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">REGRESSION_TASKS</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Voting classifier predict proba does not support batch size</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="c1"># Check that all probability values lie between 0 and 1.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">prediction</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
                <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For </span><span class="si">{}</span><span class="s2">, prediction probability not within [0, 1]: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pipeline</span><span class="p">,</span>
                    <span class="n">prediction</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> \
            <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Prediction shape for model </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> while X_.shape is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span>


<span class="k">class</span> <span class="nc">BaseTask</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for the tasks that serve as API to the pipelines.</span>
<span class="sd">    Args:</span>
<span class="sd">        seed (int), (default=1): seed to be used for reproducibility.</span>
<span class="sd">        n_jobs (int), (default=1): number of consecutive processes to spawn.</span>
<span class="sd">        logging_config (Optional[Dict]): specifies configuration</span>
<span class="sd">            for logging, if None, it is loaded from the logging.yaml</span>
<span class="sd">        ensemble_size (int), (default=50): Number of models added to the ensemble built by</span>
<span class="sd">            Ensemble selection from libraries of models.</span>
<span class="sd">            Models are drawn with replacement.</span>
<span class="sd">        ensemble_nbest (int), (default=50): only consider the ensemble_nbest</span>
<span class="sd">            models to build the ensemble</span>
<span class="sd">        max_models_on_disc (int), (default=50): maximum number of models saved to disc.</span>
<span class="sd">            Also, controls the size of the ensemble as any additional models will be deleted.</span>
<span class="sd">            Must be greater than or equal to 1.</span>
<span class="sd">        temporary_directory (str): folder to store configuration output and log file</span>
<span class="sd">        output_directory (str): folder to store predictions for optional test set</span>
<span class="sd">        delete_tmp_folder_after_terminate (bool): determines whether to delete the temporary directory,</span>
<span class="sd">            when finished</span>
<span class="sd">        include_components (Optional[Dict]): If None, all possible components are used.</span>
<span class="sd">            Otherwise specifies set of components to use.</span>
<span class="sd">        exclude_components (Optional[Dict]): If None, all possible components are used.</span>
<span class="sd">            Otherwise specifies set of components not to use. Incompatible with include</span>
<span class="sd">            components</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">logging_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">ensemble_nbest</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">max_models_on_disc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">temporary_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">delete_tmp_folder_after_terminate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">delete_output_folder_after_terminate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">include_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Backend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">search_space_updates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HyperparameterSearchSpaceUpdates</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span> <span class="o">=</span> <span class="n">ensemble_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_nbest</span> <span class="o">=</span> <span class="n">ensemble_nbest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_models_on_disc</span> <span class="o">=</span> <span class="n">max_models_on_disc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">logging_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">include_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_directory</span> <span class="o">=</span> <span class="n">temporary_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_directory</span> <span class="o">=</span> <span class="n">output_directory</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span>
                <span class="n">temporary_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_temporary_directory</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_directory</span><span class="p">,</span>
                <span class="n">delete_tmp_folder_after_terminate</span><span class="o">=</span><span class="n">delete_tmp_folder_after_terminate</span><span class="p">,</span>
                <span class="n">delete_output_folder_after_terminate</span><span class="o">=</span><span class="n">delete_output_folder_after_terminate</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span> <span class="o">=</span> <span class="n">StopWatch</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span> <span class="o">=</span> <span class="n">replace_string_bool_to_bool</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../configs/default_pipeline_options.json&#39;</span><span class="p">))))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">search_space</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConfigurationSpace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_requirements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">FitRequirement</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">autoPyTorchMetric</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PicklableClientLogger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RunHistory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_models_</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># By default try to use the TCP logging port or get a new port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_port</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">DEFAULT_TCP_LOGGING_PORT</span>

        <span class="c1"># Store the resampling strategy from the dataset, to load models as needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resampling_strategy</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Union[CrossValTypes, HoldoutValTypes]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[multiprocessing.synchronize.Event]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">search_space_updates</span> <span class="o">=</span> <span class="n">search_space_updates</span>
        <span class="k">if</span> <span class="n">search_space_updates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">search_space_updates</span><span class="p">,</span>
                              <span class="n">HyperparameterSearchSpaceUpdates</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected search space updates to be of instance&quot;</span>
                                 <span class="s2">&quot; HyperparameterSearchSpaceUpdates got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">search_space_updates</span><span class="p">)))</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_required_dataset_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        given a pipeline type, this function returns the</span>
<span class="sd">        dataset properties required by the dataset object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">build_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BasePipeline</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build pipeline according to current task</span>
<span class="sd">        and for the passed dataset properties</span>
<span class="sd">        Args:</span>
<span class="sd">            dataset_properties (Dict[str,Any]):</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">set_pipeline_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pipeline_config_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether arguments are valid and</span>
<span class="sd">        then sets them to the current pipeline</span>
<span class="sd">        configuration.</span>
<span class="sd">        Args:</span>
<span class="sd">            **pipeline_config_kwargs: Valid config options include &quot;num_run&quot;,</span>
<span class="sd">            &quot;device&quot;, &quot;budget_type&quot;, &quot;epochs&quot;, &quot;runtime&quot;, &quot;torch_num_threads&quot;,</span>
<span class="sd">            &quot;early_stopping&quot;, &quot;use_tensorboard_logger&quot;, &quot;use_pynisher&quot;,</span>
<span class="sd">            &quot;metrics_during_training&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unknown_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pipeline_config_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unknown_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid configuration arguments given </span><span class="si">{}</span><span class="s2">,&quot;</span>
                             <span class="s2">&quot; expected arguments to be in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                             <span class="nb">format</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pipeline_config_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pipeline_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current pipeline configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span>

    <span class="c1"># def set_search_space(self, search_space: ConfigurationSpace) -&gt; None:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Update the search space.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     raise NotImplementedError</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">get_search_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfigurationSpace</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current search space as ConfigurationSpace object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_space</span>
        <span class="k">elif</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset_requirements</span> <span class="o">=</span> <span class="n">get_dataset_requirements</span><span class="p">(</span>
                <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_required_dataset_properties</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">get_configuration_space</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_dataset_properties</span><span class="p">(</span><span class="n">dataset_requirements</span><span class="p">),</span>
                                           <span class="n">include</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">include_components</span><span class="p">,</span>
                                           <span class="n">exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_components</span><span class="p">,</span>
                                           <span class="n">search_space_updates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_space_updates</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No search space initialised and no dataset passed. &quot;</span>
                        <span class="s2">&quot;Can&#39;t create default search space without the dataset&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PicklableClientLogger</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates the logger used throughout the experiment</span>
<span class="sd">        Args:</span>
<span class="sd">            name (str): name of the log file,</span>
<span class="sd">            usually the dataset name</span>

<span class="sd">        Returns:</span>
<span class="sd">            PicklableClientLogger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger_name</span> <span class="o">=</span> <span class="s1">&#39;AutoPyTorch:</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># Setup the configuration for the logger</span>
        <span class="c1"># This is gonna be honored by the server</span>
        <span class="c1"># Which is created below</span>
        <span class="n">setup_logger</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">logger_name</span><span class="p">),</span>
            <span class="n">logging_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_config</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">temporary_directory</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># As Auto-sklearn works with distributed process,</span>
        <span class="c1"># we implement a logger server that can receive tcp</span>
        <span class="c1"># pickled messages. They are unpickled and processed locally</span>
        <span class="c1"># under the above logging configuration setting</span>
        <span class="c1"># We need to specify the logger_name so that received records</span>
        <span class="c1"># are treated under the logger_name ROOT logger setting</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>  <span class="c1"># be safe by using a long</span>
        <span class="n">port</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># &quot;BaseContext&quot; has no attribute &quot;Process&quot; motivates to ignore the attr check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_server</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>  <span class="c1"># type: ignore [attr-defined]</span>
            <span class="n">target</span><span class="o">=</span><span class="n">start_log_server</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                <span class="n">logname</span><span class="o">=</span><span class="n">logger_name</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">logger_name</span><span class="p">),</span>
                <span class="n">logging_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_config</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">temporary_directory</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logging_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">port</span><span class="o">.</span><span class="n">get_lock</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">get_named_client_logger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">logger_name</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_port</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        cleans the logging server created</span>
<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stop_logging_server&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Clean up the logger</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_server</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="c1"># We try to join the process, after we sent</span>
            <span class="c1"># the terminate event. Then we try a join to</span>
            <span class="c1"># nicely join the event. In case something</span>
            <span class="c1"># bad happens with nicely trying to kill the</span>
            <span class="c1"># process, we execute a terminate to kill the</span>
            <span class="c1"># process.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logging_server</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logging_server</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span>

    <span class="k">def</span> <span class="nf">_create_dask_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates the dask client that is used to parallelize</span>
<span class="sd">        the training of pipelines</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_dask_client_internally_created</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s1">&#39;distributed.worker.daemon&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">LocalCluster</span><span class="p">(</span>
                <span class="n">n_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
                <span class="n">processes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="c1"># We use the temporal directory to save the</span>
                <span class="c1"># dask workers, because deleting workers</span>
                <span class="c1"># more time than deleting backend directories</span>
                <span class="c1"># This prevent an error saying that the worker</span>
                <span class="c1"># file was deleted, so the client could not close</span>
                <span class="c1"># the worker properly</span>
                <span class="n">local_directory</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span>
                <span class="c1"># Memory is handled by the pynisher, not by the dask worker/nanny</span>
                <span class="n">memory_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="c1"># Heartbeat every 10s</span>
            <span class="n">heartbeat_interval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_dask_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the created dask client</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_is_dask_client_internally_created&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dask_client_internally_created</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_dask_client_internally_created</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dask_client_internally_created</span>

    <span class="k">def</span> <span class="nf">_load_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resampling_strategy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CrossValTypes</span><span class="p">,</span> <span class="n">HoldoutValTypes</span><span class="p">]]</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the models saved in the temporary directory</span>
<span class="sd">        during the smac run and the final ensemble created</span>
<span class="sd">        Args:</span>
<span class="sd">            resampling_strategy (Union[CrossValTypes, HoldoutValTypes]): resampling strategy used to split the data</span>
<span class="sd">                and to validate the performance of a candidate pipeline</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resampling_strategy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Resampling strategy is needed to determine what models to load&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">load_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># If no ensemble is loaded, try to get the best performing model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_best_individual_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="p">:</span>
            <span class="n">identifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="o">.</span><span class="n">get_selected_model_identifiers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">load_models_by_identifiers</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resampling_strategy</span><span class="p">,</span> <span class="n">CrossValTypes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cv_models_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">load_cv_models_by_identifiers</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resampling_strategy</span><span class="p">,</span> <span class="n">CrossValTypes</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_models_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No models fitted!&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;pipeline&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_file_output</span><span class="p">:</span>
            <span class="n">model_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">list_all_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No models fitted!&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">models_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_load_best_individual_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SingleBest</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In case of failure during ensemble building,</span>
<span class="sd">        this method returns the single best model found</span>
<span class="sd">        by AutoML.</span>
<span class="sd">        This is a robust mechanism to be able to predict,</span>
<span class="sd">        even though no ensemble was found by ensemble builder.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Providing a metric to AutoPytorch is required to fit a model. &quot;</span>
                             <span class="s2">&quot;A default metric could not be inferred. Please check the log &quot;</span>
                             <span class="s2">&quot;for error messages.&quot;</span>
                             <span class="p">)</span>

        <span class="c1"># SingleBest contains the best model found by AutoML</span>
        <span class="n">ensemble</span> <span class="o">=</span> <span class="n">SingleBest</span><span class="p">(</span>
            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">run_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_history</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No valid ensemble was created. Please check the log&quot;</span>
                <span class="s2">&quot;file for errors. Default to the best individual estimator:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ensemble</span><span class="o">.</span><span class="n">identifiers_</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;No valid ensemble was created. Please check the log&quot;</span>
                <span class="s2">&quot;file for errors. Default to the best individual estimator:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ensemble</span><span class="o">.</span><span class="n">identifiers_</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble</span>

    <span class="k">def</span> <span class="nf">_do_dummy_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_run</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to create dummy predictions.&quot;</span><span class="p">)</span>

        <span class="n">memory_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory_limit</span>
        <span class="k">if</span> <span class="n">memory_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">memory_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">memory_limit</span><span class="p">))</span>

        <span class="n">scenario_mock</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="n">scenario_mock</span><span class="o">.</span><span class="n">wallclock_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_for_task</span>
        <span class="c1"># This stats object is a hack - maybe the SMAC stats object should</span>
        <span class="c1"># already be generated here!</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">Stats</span><span class="p">(</span><span class="n">scenario_mock</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">start_timing</span><span class="p">()</span>
        <span class="n">ta</span> <span class="o">=</span> <span class="n">ExecuteTaFuncWithQueue</span><span class="p">(</span>
            <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
            <span class="n">cost_for_crash</span><span class="o">=</span><span class="n">get_cost_of_crash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">),</span>
            <span class="n">abort_on_first_run_crash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">initial_num_run</span><span class="o">=</span><span class="n">num_run</span><span class="p">,</span>
            <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
            <span class="n">memory_limit</span><span class="o">=</span><span class="n">memory_limit</span><span class="p">,</span>
            <span class="n">disable_file_output</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disable_file_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">all_supported_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_supported_metrics</span>
        <span class="p">)</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">additional_info</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">num_run</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_for_task</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">StatusType</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished creating dummy predictions.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">additional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exitcode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">6</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Dummy prediction failed with run state </span><span class="si">%s</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;The error suggests that the provided memory limits were too tight. Please &quot;</span>
                    <span class="s2">&quot;increase the &#39;ml_memory_limit&#39; and try again. If this does not solve your &quot;</span>
                    <span class="s2">&quot;problem, please open an issue and paste the additional output. &quot;</span>
                    <span class="s2">&quot;Additional output: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">additional_info</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Fail if dummy prediction fails.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Dummy prediction failed with run state </span><span class="si">%s</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;The error suggests that the provided memory limits were too tight. Please &quot;</span>
                    <span class="s2">&quot;increase the &#39;ml_memory_limit&#39; and try again. If this does not solve your &quot;</span>
                    <span class="s2">&quot;problem, please open an issue and paste the additional output. &quot;</span>
                    <span class="s2">&quot;Additional output: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">additional_info</span><span class="p">)),</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Dummy prediction failed with run state </span><span class="si">%s</span><span class="s2"> and additional output: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">additional_info</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Fail if dummy prediction fails.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Dummy prediction failed with run state </span><span class="si">%s</span><span class="s2"> and additional output: </span><span class="si">%s</span><span class="s2">.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">additional_info</span><span class="p">))</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_traditional_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_run</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time_for_traditional</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to create dummy predictions.&quot;</span><span class="p">)</span>

        <span class="n">memory_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memory_limit</span>
        <span class="k">if</span> <span class="n">memory_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">memory_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">memory_limit</span><span class="p">))</span>
        <span class="n">available_classifiers</span> <span class="o">=</span> <span class="n">get_available_classifiers</span><span class="p">()</span>
        <span class="n">dask_futures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">time_for_traditional_classifier_sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_for_traditional</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_classifiers</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n_r</span><span class="p">,</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">available_classifiers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">num_run</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">scenario_mock</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
            <span class="n">scenario_mock</span><span class="o">.</span><span class="n">wallclock_limit</span> <span class="o">=</span> <span class="n">time_for_traditional_classifier_sec</span>
            <span class="c1"># This stats object is a hack - maybe the SMAC stats object should</span>
            <span class="c1"># already be generated here!</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">Stats</span><span class="p">(</span><span class="n">scenario_mock</span><span class="p">)</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">start_timing</span><span class="p">()</span>
            <span class="n">ta</span> <span class="o">=</span> <span class="n">ExecuteTaFuncWithQueue</span><span class="p">(</span>
                <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                <span class="n">cost_for_crash</span><span class="o">=</span><span class="n">get_cost_of_crash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">),</span>
                <span class="n">abort_on_first_run_crash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">initial_num_run</span><span class="o">=</span><span class="n">num_run</span><span class="p">,</span>
                <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
                <span class="n">memory_limit</span><span class="o">=</span><span class="n">memory_limit</span><span class="p">,</span>
                <span class="n">disable_file_output</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disable_file_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">all_supported_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_supported_metrics</span>
            <span class="p">)</span>
            <span class="n">dask_futures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">classifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">classifier</span><span class="p">,</span>
                                                                      <span class="n">cutoff</span><span class="o">=</span><span class="n">time_for_traditional_classifier_sec</span><span class="p">)))</span>

            <span class="c1"># In the case of a serial execution, calling submit halts the run for a resource</span>
            <span class="c1"># dynamically adjust time in this case</span>
            <span class="n">time_for_traditional_classifier_sec</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="n">num_run</span> <span class="o">=</span> <span class="n">n_r</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">future</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dask_futures</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">additional_info</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">StatusType</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished creating predictions for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">classifier</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">additional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exitcode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">6</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Traditional prediction for </span><span class="si">%s</span><span class="s2"> failed with run state </span><span class="si">%s</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;The error suggests that the provided memory limits were too tight. Please &quot;</span>
                        <span class="s2">&quot;increase the &#39;ml_memory_limit&#39; and try again. If this does not solve your &quot;</span>
                        <span class="s2">&quot;problem, please open an issue and paste the additional output. &quot;</span>
                        <span class="s2">&quot;Additional output: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="n">classifier</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">additional_info</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TODO: add check for timeout, and provide feedback to user to consider increasing the time limit</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Traditional prediction for </span><span class="si">%s</span><span class="s2"> failed with run state </span><span class="si">%s</span><span class="s2"> and additional output: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="n">classifier</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">additional_info</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_run</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">,</span>
            <span class="n">optimize_metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">budget_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">total_walltime_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">func_eval_time_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
            <span class="n">traditional_per_total_budget</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">memory_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
            <span class="n">smac_scenario_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">get_smac_object_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">all_supported_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
            <span class="n">disable_file_output</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="n">load_models</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BaseTask&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for the best pipeline configuration for the given dataset.</span>

<span class="sd">        Fit both optimizes the machine learning models and builds an ensemble out of them.</span>
<span class="sd">        To disable ensembling, set ensemble_size==0.</span>
<span class="sd">        using the optimizer.</span>
<span class="sd">        Args:</span>
<span class="sd">            dataset (Dataset):</span>
<span class="sd">                The argument that will provide the dataset splits. It is</span>
<span class="sd">                a subclass of the  base dataset object which can</span>
<span class="sd">                generate the splits based on different restrictions.</span>
<span class="sd">            optimize_metric (str): name of the metric that is used to</span>
<span class="sd">                evaluate a pipeline.</span>
<span class="sd">            budget_type (Optional[str]):</span>
<span class="sd">                Type of budget to be used when fitting the pipeline.</span>
<span class="sd">                Either &#39;epochs&#39; or &#39;runtime&#39;. If not provided, uses</span>
<span class="sd">                the default in the pipeline config (&#39;epochs&#39;)</span>
<span class="sd">            budget (Optional[float]):</span>
<span class="sd">                Budget to fit a single run of the pipeline. If not</span>
<span class="sd">                provided, uses the default in the pipeline config</span>
<span class="sd">            total_walltime_limit (int), (default=100): Time limit</span>
<span class="sd">                in seconds for the search of appropriate models.</span>
<span class="sd">                By increasing this value, autopytorch has a higher</span>
<span class="sd">                chance of finding better models.</span>
<span class="sd">            func_eval_time_limit (int), (default=60): Time limit</span>
<span class="sd">                for a single call to the machine learning model.</span>
<span class="sd">                Model fitting will be terminated if the machine</span>
<span class="sd">                learning algorithm runs over the time limit. Set</span>
<span class="sd">                this value high enough so that typical machine</span>
<span class="sd">                learning algorithms can be fit on the training</span>
<span class="sd">                data.</span>
<span class="sd">            traditional_per_total_budget (float), (default=0.1):</span>
<span class="sd">                Percent of total walltime to be allocated for</span>
<span class="sd">                running traditional classifiers.</span>
<span class="sd">            memory_limit (Optional[int]), (default=4096): Memory</span>
<span class="sd">                limit in MB for the machine learning algorithm. autopytorch</span>
<span class="sd">                will stop fitting the machine learning algorithm if it tries</span>
<span class="sd">                to allocate more than memory_limit MB. If None is provided,</span>
<span class="sd">                no memory limit is set. In case of multi-processing, memory_limit</span>
<span class="sd">                will be per job. This memory limit also applies to the ensemble</span>
<span class="sd">                creation process.</span>
<span class="sd">            smac_scenario_args (Optional[Dict]): Additional arguments inserted</span>
<span class="sd">                into the scenario of SMAC. See the</span>
<span class="sd">                [SMAC documentation] (https://automl.github.io/SMAC3/master/options.html?highlight=scenario#scenario)</span>
<span class="sd">                for a list of available arguments.</span>
<span class="sd">            get_smac_object_callback (Optional[Callable]): Callback function</span>
<span class="sd">                to create an object of class</span>
<span class="sd">                [smac.optimizer.smbo.SMBO](https://automl.github.io/SMAC3/master/apidoc/smac.optimizer.smbo.html).</span>
<span class="sd">                The function must accept the arguments scenario_dict,</span>
<span class="sd">                instances, num_params, runhistory, seed and ta. This is</span>
<span class="sd">                an advanced feature. Use only if you are familiar with</span>
<span class="sd">                [SMAC](https://automl.github.io/SMAC3/master/index.html).</span>
<span class="sd">            all_supported_metrics (bool), (default=True): if True, all</span>
<span class="sd">                metrics supporting current task will be calculated</span>
<span class="sd">                for each pipeline and results will be available via cv_results</span>
<span class="sd">            precision (int), (default=32): Numeric precision used when loading</span>
<span class="sd">                ensemble data. Can be either &#39;16&#39;, &#39;32&#39; or &#39;64&#39;.</span>
<span class="sd">            disable_file_output (Union[bool, List]):</span>
<span class="sd">            load_models (bool), (default=True): Whether to load the</span>
<span class="sd">                models after fitting AutoPyTorch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">!=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible dataset entered for current task,&quot;</span>
                             <span class="s2">&quot;expected dataset to have task type :</span><span class="si">{}</span><span class="s2"> got &quot;</span>
                             <span class="s2">&quot;:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">task_type</span><span class="p">))</span>

        <span class="c1"># Initialise information needed for the experiment</span>
        <span class="n">experiment_task_name</span> <span class="o">=</span> <span class="s1">&#39;runSearch&#39;</span>
        <span class="n">dataset_requirements</span> <span class="o">=</span> <span class="n">get_dataset_requirements</span><span class="p">(</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_required_dataset_properties</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_requirements</span> <span class="o">=</span> <span class="n">dataset_requirements</span>
        <span class="n">dataset_properties</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_dataset_properties</span><span class="p">(</span><span class="n">dataset_requirements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">experiment_task_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resampling_strategy</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">resampling_strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_supported_metrics</span> <span class="o">=</span> <span class="n">all_supported_metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_file_output</span> <span class="o">=</span> <span class="n">disable_file_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_memory_limit</span> <span class="o">=</span> <span class="n">memory_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_for_task</span> <span class="o">=</span> <span class="n">total_walltime_limit</span>
        <span class="c1"># Save start time to backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">save_start_time</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">save_datamanager</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">optimize_metric</span><span class="p">],</span> <span class="n">dataset_properties</span><span class="o">=</span><span class="n">dataset_properties</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">search_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_search_space</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="n">budget_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">budget_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">budget_config</span><span class="p">[</span><span class="s1">&#39;budget_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">budget_type</span>
            <span class="n">budget_config</span><span class="p">[</span><span class="n">budget_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">budget</span>
        <span class="k">elif</span> <span class="n">budget_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;budget type was not specified in budget_config&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret task type from the dataset&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_dask_client</span><span class="p">()</span>

        <span class="c1"># ============&gt; Run dummy predictions</span>
        <span class="n">num_run</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">dummy_task_name</span> <span class="o">=</span> <span class="s1">&#39;runDummy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">dummy_task_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_dummy_prediction</span><span class="p">(</span><span class="n">num_run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">stop_task</span><span class="p">(</span><span class="n">dummy_task_name</span><span class="p">)</span>

        <span class="c1"># ============&gt; Run traditional ml</span>

        <span class="n">traditional_task_name</span> <span class="o">=</span> <span class="s1">&#39;runTraditional&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">traditional_task_name</span><span class="p">)</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">wall_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="n">time_for_traditional</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">traditional_per_total_budget</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_for_task</span> <span class="o">-</span> <span class="n">elapsed_time</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">time_for_traditional</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traditional_per_total_budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough time allocated to run traditional algorithms&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">traditional_per_total_budget</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_traditional_prediction</span><span class="p">(</span><span class="n">num_run</span><span class="o">=</span><span class="n">num_run</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time_for_traditional</span><span class="o">=</span><span class="n">time_for_traditional</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">stop_task</span><span class="p">(</span><span class="n">traditional_task_name</span><span class="p">)</span>

        <span class="c1"># ============&gt; Starting ensemble</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">wall_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="n">time_left_for_ensembles</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_walltime_limit</span> <span class="o">-</span> <span class="n">elapsed_time</span><span class="p">)</span>
        <span class="n">proc_ensemble</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">time_left_for_ensembles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Fit only raises error when ensemble_size is not zero but</span>
            <span class="c1"># time_left_for_ensembles is zero.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not starting ensemble builder because there &quot;</span>
                                 <span class="s2">&quot;is no time left. Try increasing the value &quot;</span>
                                 <span class="s2">&quot;of time_left_for_this_task.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not starting ensemble builder as ensemble size is 0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting ensemble&quot;</span><span class="p">)</span>
            <span class="n">ensemble_task_name</span> <span class="o">=</span> <span class="s1">&#39;ensemble&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">ensemble_task_name</span><span class="p">)</span>
            <span class="n">proc_ensemble</span> <span class="o">=</span> <span class="n">EnsembleBuilderManager</span><span class="p">(</span>
                <span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">time_left_for_ensembles</span><span class="o">=</span><span class="n">time_left_for_ensembles</span><span class="p">,</span>
                <span class="n">backend</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">),</span>
                <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                <span class="n">output_type</span><span class="o">=</span><span class="n">STRING_TO_OUTPUT_TYPES</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">output_type</span><span class="p">],</span>
                <span class="n">task_type</span><span class="o">=</span><span class="n">STRING_TO_TASK_TYPES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">],</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">],</span>
                <span class="n">opt_metric</span><span class="o">=</span><span class="n">optimize_metric</span><span class="p">,</span>
                <span class="n">ensemble_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span><span class="p">,</span>
                <span class="n">ensemble_nbest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_nbest</span><span class="p">,</span>
                <span class="n">max_models_on_disc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_models_on_disc</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                <span class="n">max_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">read_at_most</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                <span class="n">ensemble_memory_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory_limit</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span>
                <span class="n">logger_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_port</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">stop_task</span><span class="p">(</span><span class="n">ensemble_task_name</span><span class="p">)</span>

        <span class="c1"># ==&gt; Run SMAC</span>
        <span class="n">smac_task_name</span> <span class="o">=</span> <span class="s1">&#39;runSMAC&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">smac_task_name</span><span class="p">)</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="o">.</span><span class="n">wall_elapsed</span><span class="p">(</span><span class="n">experiment_task_name</span><span class="p">)</span>
        <span class="n">time_left_for_smac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_walltime_limit</span> <span class="o">-</span> <span class="n">elapsed_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting SMAC with </span><span class="si">%5.2f</span><span class="s2"> sec time left&quot;</span> <span class="o">%</span> <span class="n">time_left_for_smac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_left_for_smac</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; Not starting SMAC because there is no time left&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">_proc_smac</span> <span class="o">=</span> <span class="n">AutoMLSMBO</span><span class="p">(</span>
                <span class="n">config_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_space</span><span class="p">,</span>
                <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
                <span class="n">total_walltime_limit</span><span class="o">=</span><span class="n">total_walltime_limit</span><span class="p">,</span>
                <span class="n">func_eval_time_limit</span><span class="o">=</span><span class="n">func_eval_time_limit</span><span class="p">,</span>
                <span class="n">dask_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span><span class="p">,</span>
                <span class="n">memory_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_memory_limit</span><span class="p">,</span>
                <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
                <span class="n">watcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stopwatch</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                <span class="n">include</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">include_components</span><span class="p">,</span>
                <span class="n">exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_components</span><span class="p">,</span>
                <span class="n">disable_file_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_disable_file_output</span><span class="p">,</span>
                <span class="n">all_supported_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_supported_metrics</span><span class="p">,</span>
                <span class="n">smac_scenario_args</span><span class="o">=</span><span class="n">smac_scenario_args</span><span class="p">,</span>
                <span class="n">get_smac_object_callback</span><span class="o">=</span><span class="n">get_smac_object_callback</span><span class="p">,</span>
                <span class="n">pipeline_config</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span><span class="p">,</span> <span class="o">**</span><span class="n">budget_config</span><span class="p">},</span>
                <span class="n">ensemble_callback</span><span class="o">=</span><span class="n">proc_ensemble</span><span class="p">,</span>
                <span class="n">logger_port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_port</span><span class="p">,</span>
                <span class="n">start_num_run</span><span class="o">=</span><span class="n">num_run</span><span class="p">,</span>
                <span class="n">search_space_updates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_space_updates</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_history</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">budget_type</span> <span class="o">=</span> \
                    <span class="n">_proc_smac</span><span class="o">.</span><span class="n">run_smbo</span><span class="p">()</span>
                <span class="n">trajectory_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">get_smac_output_directory_for_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">),</span>
                    <span class="s1">&#39;trajectory.json&#39;</span><span class="p">)</span>
                <span class="n">saveable_trajectory</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">entry</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_dictionary</span><span class="p">()]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
                     <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">]</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">trajectory_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">saveable_trajectory</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span>
        <span class="c1"># Wait until the ensemble process is finished to avoid shutting down</span>
        <span class="c1"># while the ensemble builder tries to access the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Shutdown&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">proc_ensemble</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_performance_history</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">proc_ensemble</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>

            <span class="c1"># save the ensemble performance history file</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_performance_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_performance_history</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">internals_directory</span><span class="p">,</span> <span class="s1">&#39;ensemble_history.json&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proc_ensemble</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">proc_ensemble</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="c1"># Now we need to wait for the future to return as it cannot be cancelled while it</span>
                <span class="c1"># is running: https://stackoverflow.com/a/49203129</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ensemble script still running, waiting for it to finish.&quot;</span><span class="p">)</span>
                <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ensemble script finished, continue shutdown.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing the dask infrastructure&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_dask_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished closing the dask infrastructure&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">load_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading models...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_models</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">resampling_strategy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished loading models...&quot;</span><span class="p">)</span>

        <span class="c1"># Clean up the logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to clean up the logger&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_logger</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">refit</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">,</span>
            <span class="n">budget_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="n">split_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BaseTask&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refit all models found with fit to new data.</span>

<span class="sd">        Necessary when using cross-validation. During training, autoPyTorch</span>
<span class="sd">        fits each model k times on the dataset, but does not keep any trained</span>
<span class="sd">        model and can therefore not be used to predict for new data points.</span>
<span class="sd">        This methods fits all models found during a call to fit on the data</span>
<span class="sd">        given. This method may also be used together with holdout to avoid</span>
<span class="sd">        only using 66% of the training data to fit the final model.</span>
<span class="sd">        Args:</span>
<span class="sd">            dataset: (Dataset)</span>
<span class="sd">                The argument that will provide the dataset splits. It can either</span>
<span class="sd">                be a dictionary with the splits, or the dataset object which can</span>
<span class="sd">                generate the splits based on different restrictions.</span>
<span class="sd">            budget_config: (Optional[Dict[str, Union[int, str]]])</span>
<span class="sd">                can contain keys from &#39;budget_type&#39; and the budget</span>
<span class="sd">                specified using &#39;epochs&#39; or &#39;runtime&#39;.</span>
<span class="sd">            split_id: (int)</span>
<span class="sd">                split id to fit on.</span>
<span class="sd">        Returns:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span>

        <span class="n">dataset_requirements</span> <span class="o">=</span> <span class="n">get_dataset_requirements</span><span class="p">(</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_required_dataset_properties</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="n">dataset_properties</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_dataset_properties</span><span class="p">(</span><span class="n">dataset_requirements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">save_datamanager</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="n">X</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;dataset_properties&#39;</span><span class="p">:</span> <span class="n">dataset_properties</span><span class="p">,</span>
                                  <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
                                  <span class="s1">&#39;X_train&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="s1">&#39;y_train&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="s1">&#39;X_test&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;y_test&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;train_indices&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split_id</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="s1">&#39;val_indices&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split_id</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="s1">&#39;split_id&#39;</span><span class="p">:</span> <span class="n">split_id</span><span class="p">,</span>
                                  <span class="s1">&#39;num_run&#39;</span><span class="p">:</span> <span class="mi">0</span>
                                  <span class="p">})</span>
        <span class="n">X</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span><span class="p">,</span> <span class="o">**</span><span class="n">budget_config</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_models</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">resampling_strategy</span><span class="p">)</span>

        <span class="c1"># Refit is not applicable when ensemble_size is set to zero.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Refit can only be called if &#39;ensemble_size != 0&#39;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            <span class="c1"># this updates the model inplace, it can then later be used in</span>
            <span class="c1"># predict method</span>

            <span class="c1"># try to fit the model. If it fails, shuffle the data. This</span>
            <span class="c1"># could alleviate the problem in algorithms that depend on</span>
            <span class="c1"># the ordering of the data.</span>
            <span class="n">fit_and_suppress_warnings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_logger</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">,</span>
            <span class="n">budget_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="n">pipeline_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Configuration</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">split_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BasePipeline</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a pipeline on the given task for the budget.</span>
<span class="sd">        A pipeline configuration can be specified if None,</span>
<span class="sd">        uses default</span>
<span class="sd">        Args:</span>
<span class="sd">            dataset: (Dataset)</span>
<span class="sd">                The argument that will provide the dataset splits. It can either</span>
<span class="sd">                be a dictionary with the splits, or the dataset object which can</span>
<span class="sd">                generate the splits based on different restrictions.</span>
<span class="sd">            budget_config: (Optional[Dict[str, Union[int, str]]])</span>
<span class="sd">                can contain keys from &#39;budget_type&#39; and the budget</span>
<span class="sd">                specified using &#39;epochs&#39; or &#39;runtime&#39;.</span>
<span class="sd">            split_id: (int) (default=0)</span>
<span class="sd">                split id to fit on.</span>
<span class="sd">            pipeline_config: (Optional[Configuration])</span>
<span class="sd">                configuration to fit the pipeline with. If None,</span>
<span class="sd">                uses default</span>

<span class="sd">        Returns:</span>
<span class="sd">            (BasePipeline): fitted pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">)</span>

        <span class="c1"># get dataset properties</span>
        <span class="n">dataset_requirements</span> <span class="o">=</span> <span class="n">get_dataset_requirements</span><span class="p">(</span>
            <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_required_dataset_properties</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="n">dataset_properties</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_dataset_properties</span><span class="p">(</span><span class="n">dataset_requirements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">save_datamanager</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># build pipeline</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_pipeline</span><span class="p">(</span><span class="n">dataset_properties</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">set_hyperparameters</span><span class="p">(</span><span class="n">pipeline_config</span><span class="p">)</span>

        <span class="c1"># initialise fit dictionary</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;dataset_properties&#39;</span><span class="p">:</span> <span class="n">dataset_properties</span><span class="p">,</span>
                                  <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
                                  <span class="s1">&#39;X_train&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="s1">&#39;y_train&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="s1">&#39;X_test&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;y_test&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">test_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;train_indices&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split_id</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="s1">&#39;val_indices&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">split_id</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="s1">&#39;split_id&#39;</span><span class="p">:</span> <span class="n">split_id</span><span class="p">,</span>
                                  <span class="s1">&#39;num_run&#39;</span><span class="p">:</span> <span class="mi">0</span>
                                  <span class="p">})</span>
        <span class="n">X</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_options</span><span class="p">,</span> <span class="o">**</span><span class="n">budget_config</span><span class="p">})</span>

        <span class="n">fit_and_suppress_warnings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_logger</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pipeline</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate the estimator predictions.</span>
<span class="sd">        Generate the predictions based on the given examples from the test set.</span>
<span class="sd">        Args:</span>
<span class="sd">        X_test: (np.ndarray)</span>
<span class="sd">            The test set examples.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Array with estimator predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Parallelize predictions across models with n_jobs processes.</span>
        <span class="c1"># Each process computes predictions in chunks of batch_size rows.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="s2">&quot;Predict-Logger&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling_strategy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No ensemble found. Either fit has not yet &quot;</span>
                             <span class="s2">&quot;been called or no ensemble was fitted&quot;</span><span class="p">)</span>

        <span class="c1"># Mypy assert</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Load models should error out if no ensemble&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Union</span><span class="p">[</span><span class="n">SingleBest</span><span class="p">,</span> <span class="n">EnsembleSelection</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling_strategy</span><span class="p">,</span> <span class="n">HoldoutValTypes</span><span class="p">):</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling_strategy</span><span class="p">,</span> <span class="n">CrossValTypes</span><span class="p">):</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_models_</span>

        <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)(</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">_pipeline_predict</span><span class="p">)(</span>
                <span class="n">models</span><span class="p">[</span><span class="n">identifier</span><span class="p">],</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="o">.</span><span class="n">get_selected_model_identifiers</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Something went wrong generating the predictions. &#39;</span>
                             <span class="s1">&#39;The ensemble should consist of the following &#39;</span>
                             <span class="s1">&#39;models: </span><span class="si">%s</span><span class="s1">, the following models were loaded: &#39;</span>
                             <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="o">.</span><span class="n">indices_</span><span class="p">)),</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_</span><span class="p">))))</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="ow">in</span> <span class="n">REGRESSION_TASKS</span><span class="p">:</span>
            <span class="c1"># Make sure prediction probabilities</span>
            <span class="c1"># are within a valid range</span>
            <span class="c1"># Individual models are checked in _pipeline_predict</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">predictions</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For ensemble </span><span class="si">{}</span><span class="s2">, prediction probability not within [0, 1]!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_logger</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">predictions</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">y_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate the score on the test set.</span>
<span class="sd">        Calculate the evaluation measure on the test set.</span>
<span class="sd">        Args:</span>
<span class="sd">        y_pred: (np.ndarray)</span>
<span class="sd">            The test predictions</span>
<span class="sd">        y_test: (np.ndarray)</span>
<span class="sd">            The test ground truth labels.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: Value of the evaluation metric calculated on the test set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No metric found. Either fit/search has not been called yet &quot;</span>
                             <span class="s2">&quot;or AutoPyTorch failed to infer a metric from the dataset &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;AutoPytorch failed to infer a task type from the dataset &quot;</span>
                             <span class="s2">&quot;Please check the log file for related errors. &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculate_score</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">prediction</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span>
                               <span class="n">task_type</span><span class="o">=</span><span class="n">STRING_TO_TASK_TYPES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">],</span>
                               <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># Cannot serialize a client!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dask_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_server</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore [assignment]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_logging_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Clean up the logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_logger</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_close_dask_client</span><span class="p">()</span>

        <span class="c1"># When a multiprocessing work is done, the</span>
        <span class="c1"># objects are deleted. We don&#39;t want to delete run areas</span>
        <span class="c1"># until the estimator is deleted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">delete_directories</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">no_type_check</span>
    <span class="k">def</span> <span class="nf">get_incumbent_results</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">no_type_check</span>
    <span class="k">def</span> <span class="nf">get_incumbent_config</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2014-2019, Machine Learning Professorship Freiburg.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>